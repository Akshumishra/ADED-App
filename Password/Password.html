<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Password Manager</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css">
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>
<body>
    <h1>Password Manager</h1>

    <!-- Section for password generation -->
    <h3>Generate Strong Password</h3>
    <button id="generatePasswordBtn">Generate Strong Password</button>
    <p id="generatedPassword"></p>

    <!-- Section for storing password -->
    <h3>Store Password</h3>
    <label for="passwordToStore">Enter Password to Store:</label>
    <input type="text" id="passwordToStore" placeholder="Enter password">
    <button id="encryptAndStoreBtn">Encrypt & Store</button>
    <p id="storeStatus"></p>
    <p id="securityKeyDisplay"></p> <!-- To display the encryption key -->

    <!-- Section for security key and retrieving stored password -->
    <h3>Retrieve Password</h3>
    <label for="securityKey">Enter Security Key:</label>
    <input type="text" id="securityKey" placeholder="Enter security key">
    <button id="retrievePasswordBtn">Retrieve Stored Password</button>
    <p id="retrievedPassword"></p>

    <!-- Multi-Factor Authentication (MFA) simulation -->
    <h3>Multi-Factor Authentication (MFA)</h3>
    <label for="mfaCode">Enter MFA Code (123456):</label>
    <input type="text" id="mfaCode" placeholder="Enter MFA code">
    <button id="validateMfaBtn">Validate MFA</button>
    <p id="mfaStatus"></p>

    <py-env>
        - micropip
    </py-env>

    <py-script>
        import micropip
        import random
        import string
        import asyncio
        import os

        # Global variables to store keys and encrypted data
        cipher_suite = None
        encryption_key = None  # This will store the key used to encrypt/decrypt passwords

        # Install cryptography package
        async def setup_cryptography():
            await micropip.install("cryptography")
            from cryptography.fernet import Fernet

            global cipher_suite
            global encryption_key

            # Generate and store the encryption key
            encryption_key = Fernet.generate_key()
            cipher_suite = Fernet(encryption_key)

            # Create a simulated file for storing encrypted passwords
            global password_file
            password_file = "passwords.txt"
            if not os.path.exists(password_file):
                with open(password_file, "w") as f:
                    f.write("")  # Empty file to store encrypted passwords
        
        asyncio.ensure_future(setup_cryptography())

        # Feature 1: Generate Strong Password
        def generate_password(*args):
            chars = string.ascii_letters + string.digits + string.punctuation
            strong_password = ''.join(random.choice(chars) for i in range(16))
            Element("generatedPassword").element.innerHTML = f"Generated Password: {strong_password}"

        # Feature 2: Encrypt and Store Password and Show Security Key
        def encrypt_and_store_password(*args):
            password_input = Element("passwordToStore").element.value
            if password_input and cipher_suite:
                encrypted_password = cipher_suite.encrypt(password_input.encode())
                with open(password_file, "a") as f:
                    f.write(encrypted_password.decode() + "\n")  # Save encrypted password
                Element("storeStatus").element.innerHTML = "Password encrypted and stored successfully!"

                # Display the security key to the user
                Element("securityKeyDisplay").element.innerHTML = f"Your Security Key (save this!): {encryption_key.decode()}"

            else:
                Element("storeStatus").element.innerHTML = "Please wait, encryption setup in progress."

        # Feature 3: Decrypt and Retrieve Stored Password with Security Key Validation
        def decrypt_password(*args):
            user_key_input = Element("securityKey").element.value.encode()  # Get the user-entered security key
            if user_key_input == encryption_key:  # Check if the entered key matches the encryption key
                with open(password_file, "r") as f:
                    encrypted_password = f.readlines()[-1].strip()  # Get the last stored password
                    decrypted_password = cipher_suite.decrypt(encrypted_password.encode()).decode()
                    Element("retrievedPassword").element.innerHTML = f"Decrypted Password: {decrypted_password}"
            else:
                Element("retrievedPassword").element.innerHTML = "Invalid Security Key. Please try again."

        # Feature 4: Multi-Factor Authentication (MFA)
        def validate_mfa(*args):
            mfa_code = Element("mfaCode").element.value
            if mfa_code == "123456":  # Simulated MFA code
                Element("mfaStatus").element.innerHTML = "MFA Validation Successful!"
            else:
                Element("mfaStatus").element.innerHTML = "Invalid MFA code, please try again."

        # Attach functions to button clicks
        Element("generatePasswordBtn").element.onclick = generate_password
        Element("encryptAndStoreBtn").element.onclick = encrypt_and_store_password
        Element("retrievePasswordBtn").element.onclick = decrypt_password
        Element("validateMfaBtn").element.onclick = validate_mfa

    </py-script>
</body>
</html>